{% extends "admin/adminbase.html" %}
{% load static %}

{% block title %}Podcraze{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<link rel="stylesheet" href="{% static 'css/editproductvariant.css' %}">
<style>
    /* Simple cropper styles */
    .cropper-crop-box {
        border: 2px solid #007bff !important;
    }
    
    .cropper-view-box {
        outline: 1px solid #007bff !important;
    }
    
    .cropper-point {
        width: 8px !important;
        height: 8px !important;
        background-color: #007bff !important;
        border: 1px solid #fff !important;
        border-radius: 50% !important;
    }
    
    .cropper-line {
        background-color: rgba(0, 123, 255, 0.3) !important;
    }
</style>
{% endblock %}

{% block content %}
{% load custom_filters %}

<div class="content-wrapper">
    <h1 class="page-title">Edit Product Variant</h1>
    <div class="add-product-form">
        <form class="product-form" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="form-group">
                <label>Color</label>
                <input type="text" class="form-control" maxlength="10" name="color" value="{{ variant.color }}" required>
            </div>

            <div class="form-group">
                <label>Price</label>
                <input type="text" class="form-control" maxlength="6" name="price" value="{{ variant.price }}" required>
            </div>

            <div class="form-group">
                <label>Stock</label>
                <input type="number" class="form-control" min="0" max="9999" name="stock" value="{{ variant.stock }}" required>
            </div>

            <div class="form-group">
                {% for image in product_images %}
                    <div class="image-input-group">
                        <label>Product Image {{ forloop.counter }}</label>
                        {% if image.image_path %}
                            <div class="preview-container" id="preview{{ forloop.counter }}">
                                <img src="{{ image.image_path.url }}" alt="Product Image {{ forloop.counter }}" 
                                     style="max-width: 100px; max-height: 100px;">
                            </div>
                        {% endif %}
                        <input type="file" class="product-image" id="productImage{{ forloop.counter }}" 
                               name="productImage{{ forloop.counter }}" accept="image/*">
                    </div>
                {% endfor %}
                
                {% for i in remaining_image_slots %}
                    <div class="image-input-group">
                        <label>Product Image {{ forloop.counter|add:product_images.count }}</label>
                        <div class="preview-container" id="preview{{ forloop.counter|add:product_images.count }}"></div>
                        <input type="file" class="product-image" 
                               id="productImage{{ forloop.counter|add:product_images.count }}" 
                               name="productImage{{ forloop.counter|add:product_images.count }}" 
                               accept="image/*">
                    </div>
                {% endfor %}
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Cropper Modal -->
<div id="cropperModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; width: 90%; max-width: 800px; height: 90%; max-height: 600px; display: flex; flex-direction: column;">
        <!-- Header -->
        <div style="padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border-radius: 10px 10px 0 0;">
            <h3 style="margin: 0; color: #333;">Crop Your Image</h3>
            <button onclick="closeCropPopup()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        
        <!-- Cropper Container -->
        <div id="cropper-container" style="flex: 1; padding: 20px; position: relative; overflow: hidden;">
            <img id="cropperImage" style="max-width: 100%; max-height: 100%; display: block; margin: 0 auto;">
        </div>
        
        <!-- Footer -->
        <div style="padding: 15px 20px; border-top: 1px solid #ddd; display: flex; justify-content: flex-end; gap: 10px; background: #f8f9fa; border-radius: 0 0 10px 10px;">
            <button onclick="closeCropPopup()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button id="cropSaveBtn" onclick="cropImage()" disabled style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Loading...</button>
        </div>
    </div>
</div>

<style>
.preview-container {
    margin: 10px 0;
}

.preview-container img {
    max-width: 200px;
    max-height: 200px;
    border-radius: 4px;
}

.image-input-group {
    margin-bottom: 20px;
    padding: 15px;
    background: #2a2a2a;
    border-radius: 6px;
    border: 1px solid #444;
}

.image-input-group label {
    color: #fff;
    font-weight: bold;
    margin-bottom: 8px;
    display: block;
}

.product-image {
    width: 100%;
    padding: 8px;
    background: #333;
    border: 1px solid #555;
    border-radius: 4px;
    color: #fff;
    cursor: pointer;
}

.product-image:hover {
    border-color: #007bff;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    let cropper = null;
    let currentInput = null;
    let currentPreview = null;
    let originalFile = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Setup image inputs
        document.querySelectorAll('.product-image').forEach(input => {
            input.addEventListener('change', handleImageSelect);
        });
    });
    
    function handleImageSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
            alert('Please select a valid image file (JPEG, JPG, or PNG)');
            e.target.value = '';
            return;
        }
        
        // Store context
        currentInput = e.target;
        originalFile = file;
        const imageNumber = e.target.id.replace('productImage', '');
        currentPreview = document.getElementById('preview' + imageNumber);
        
        // Read and show modal
        const reader = new FileReader();
        reader.onload = function(event) {
            showCropModal(event.target.result);
        };
        reader.readAsDataURL(file);
    }
    
    function showCropModal(imageSrc) {
        const modal = document.getElementById('cropperModal');
        const cropperImage = document.getElementById('cropperImage');
        const cropBtn = document.getElementById('cropSaveBtn');
        
        // Destroy existing cropper
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        
        // Show modal
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Reset button
        cropBtn.disabled = true;
        cropBtn.textContent = 'Loading...';
        
        // Load image
        cropperImage.src = imageSrc;
        cropperImage.onload = function() {
            setTimeout(() => {
                initCropper();
            }, 200);
        };
    }
    
    function initCropper() {
        const cropperImage = document.getElementById('cropperImage');
        const cropBtn = document.getElementById('cropSaveBtn');
        
        try {
            cropper = new Cropper(cropperImage, {
                aspectRatio: 4/3,
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 0.7,
                responsive: true,
                guides: true,
                center: true,
                highlight: true,
                cropBoxMovable: true,
                cropBoxResizable: true,
                ready: function() {
                    cropBtn.disabled = false;
                    cropBtn.textContent = 'Crop & Save';
                    cropBtn.style.background = '#28a745';
                }
            });
        } catch (error) {
            console.error('Cropper error:', error);
            cropBtn.textContent = 'Error';
            alert('Failed to initialize cropper');
        }
    }
    
    function closeCropPopup() {
        const modal = document.getElementById('cropperModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        
        // Reset
        currentInput = null;
        currentPreview = null;
        originalFile = null;
    }
    
    function cropImage() {
        if (!cropper) {
            alert('Cropper not ready');
            return;
        }
        
        const cropBtn = document.getElementById('cropSaveBtn');
        cropBtn.disabled = true;
        cropBtn.textContent = 'Processing...';
        
        try {
            const canvas = cropper.getCroppedCanvas({
                width: 800,
                height: 600,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            canvas.toBlob(function(blob) {
                if (!blob) {
                    alert('Failed to process image');
                    cropBtn.disabled = false;
                    cropBtn.textContent = 'Crop & Save';
                    return;
                }
                
                // Create new file
                const fileName = originalFile.name.replace(/\.[^/.]+$/, '') + '_cropped.jpg';
                const croppedFile = new File([blob], fileName, { type: 'image/jpeg' });
                
                // Update input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(croppedFile);
                currentInput.files = dataTransfer.files;
                
                // Show preview
                if (currentPreview) {
                    currentPreview.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL('image/jpeg', 0.8);
                    img.style.maxWidth = '200px';
                    img.style.border = '2px solid #28a745';
                    img.style.borderRadius = '4px';
                    img.style.marginTop = '10px';
                    
                    const successText = document.createElement('p');
                    successText.textContent = 'âœ“ Image cropped successfully!';
                    successText.style.color = '#28a745';
                    successText.style.fontSize = '14px';
                    successText.style.marginTop = '5px';
                    
                    currentPreview.appendChild(img);
                    currentPreview.appendChild(successText);
                }
                
                closeCropPopup();
            }, 'image/jpeg', 0.85);
            
        } catch (error) {
            console.error('Crop error:', error);
            alert('Failed to crop image: ' + error.message);
            cropBtn.disabled = false;
            cropBtn.textContent = 'Crop & Save';
        }
    }
</script>
{% endblock %}
