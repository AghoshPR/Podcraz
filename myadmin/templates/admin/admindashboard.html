{% extends "admin/adminbase.html" %}
{% load static %}
{% block title %}Podcraze{% endblock %}


{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12 d-flex justify-content-between align-items-center mb-4">
            <h5 class="m-0">Sales Overview</h5>
            <select class="form-select bg-dark text-white" style="width: auto;">
                <option>{{ current_year }}</option>
            </select>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <span>Total Revenue</span>
                    <span class="{% if revenue_trend >= 0 %}trend-up{% else %}trend-down{% endif %}">
                        <i class="fas fa-arrow-{% if revenue_trend >= 0 %}up{% else %}down{% endif %}"></i>
                        {{ revenue_trend|floatformat:1 }}%
                    </span>
                </div>
                <div class="mt-2">
                    <h4>₹{{ total_revenue|floatformat:2 }}</h4>
                    <canvas id="revenueChart" height="30"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <span>Total Orders</span>
                    <span class="{% if orders_trend >= 0 %}trend-up{% else %}trend-down{% endif %}">
                        <i class="fas fa-arrow-{% if orders_trend >= 0 %}up{% else %}down{% endif %}"></i>
                        {{ orders_trend|floatformat:1 }}%
                    </span>
                </div>
                <div class="mt-2">
                    <h4>{{ total_orders }}</h4>
                    <canvas id="ordersChart" height="30"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <span>Total Products</span>
                    <span class="{% if products_trend >= 0 %}trend-up{% else %}trend-down{% endif %}">
                        <i class="fas fa-arrow-{% if products_trend >= 0 %}up{% else %}down{% endif %}"></i>
                        {{ products_trend|floatformat:1 }}%
                    </span>
                </div>
                <div class="mt-2">
                    <h4>{{ total_products }}</h4>
                    <canvas id="productsChart" height="30"></canvas>
                </div>
            </div>
        </div>


        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <span>Total Discounts</span>
                    <span class="{% if total_discounts >= 0 %}trend-up{% else %}trend-down{% endif %}">
                        <i class="fas fa-arrow-{% if total_discounts >= 0 %}up{% else %}down{% endif %}"></i>
                    </span>
                </div>
                <div class="mt-2">
                    <h4>₹{{ total_discounts|floatformat:2 }}</h4>
                    <canvas id="discountsChart" height="30"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <span>Total Customers</span>
                    <span class="{% if customers_trend >= 0 %}trend-up{% else %}trend-down{% endif %}">
                        <i class="fas fa-arrow-{% if customers_trend >= 0 %}up{% else %}down{% endif %}"></i>
                        {{ customers_trend|floatformat:1 }}%
                    </span>
                </div>
                <div class="mt-2">
                    <h4>{{ total_customers }}</h4>
                    <canvas id="customersChart" height="30"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="m-0">Monthly Revenue Trend</h6>
                </div>
                <canvas id="mainChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="dashboard-card">
                <h5>Generate Sales Report</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="date" class="form-control bg-dark text-white" id="start-date">
                    </div>
                    <div class="col-md-4">
                        <input type="date" class="form-control bg-dark text-white" id="end-date">
                    </div>
                    <div class="col-md-4 d-flex gap-2">
                        <button class="btn btn-primary">Apply</button>
                        <button class="btn btn-success" onclick="generateReport('excel')">
                            <i class="fas fa-file-excel"></i> Download Excel
                        </button>
                        <button class="btn btn-danger" onclick="generateReport('pdf')">
                            <i class="fas fa-file-pdf"></i> Download PDF
                        </button>
                    </div>
                </div>

                
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>DATE</th>
                                <th>ORDER ID</th>
                                <th>CUSTOMER</th>
                                <th>ORIGINAL PRICE</th>
                                <th>OFFER APPLIED</th>
                                <th>COUPON</th>
                                <th>NET AMOUNT</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in sales_report %}
                            <tr>
                                <td>{{ order.date }}</td>
                                <td class="text-primary">#{{ order.order_id }}</td>
                                <td>{{ order.customer }}</td>
                                <td>₹{{ order.original_price|floatformat:2 }}</td>
                                <td>
                                    {% if order.offer_applied == "No Offer" %}
                                        <span class="text-muted">No Offer</span>
                                    {% else %}
                                        <span class="text-success">{{ order.offer_applied }}</span>
                                    {% endif %}
                                </td>
                                <td>₹{{ order.coupon|floatformat:2 }}</td>
                                <td>₹{{ order.net_amount|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
    



            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-4">
            <div class="dashboard-card">
                <h6>Today's Sales</h6>
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Sales:</span>
                        <span>₹{{ today_sales|floatformat:2 }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Total Discounts:</span>
                        <span>₹{{ today_discounts|floatformat:2 }}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="dashboard-card">
                <h6>This Week's Sales</h6>
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Sales:</span>
                        <span>₹{{ week_sales|floatformat:2 }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Total Discounts:</span>
                        <span>₹{{ week_discounts|floatformat:2 }}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="dashboard-card">
                <h6>This Month's Sales</h6>
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Sales:</span>
                        <span>₹{{ month_sales|floatformat:2 }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Total Discounts:</span>
                        <span>₹{{ month_discounts|floatformat:2 }}</span>
                    </div>
                     <div class="d-flex justify-content-between">
                        <span>Total Discounts:</span>
                        <span>₹{{ month_discounts|floatformat:2 }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<script>
    // Initialize charts only if data exists
    {% if monthly_data %}
        const monthlyData = {{ monthly_data|safe }};
        const revenueData = monthlyData.map(item => item.revenue || 0);
        const orderData = monthlyData.map(item => item.order_count || 0);

        // Create mini charts
        createMiniChart('revenueChart', revenueData, '#4CAF50');
        createMiniChart('ordersChart', orderData, '#2196F3');
        createMiniChart('productsChart', [10, 15, 12, 18, 20, 25], '#FFC107');
        createMiniChart('customersChart', [5, 8, 12, 15, 18, 20], '#9C27B0');

        // Create main revenue chart
        createMainChart(monthlyData);
    {% endif %}

    function createMiniChart(id, data, color) {
        const ctx = document.getElementById(id)?.getContext('2d');
        if (!ctx) return;
        
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(data.length).fill(''),
                datasets: [{
                    data: data,
                    borderColor: color,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { display: false }
                },
                elements: {
                    point: { radius: 0 }
                }
            }
        });
    }

    function createMainChart(data) {
        const ctx = document.getElementById('mainChart')?.getContext('2d');
        if (!ctx) return;

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(item => {
                    const date = new Date(2024, item.month - 1);
                    return date.toLocaleString('default', { month: 'short' });
                }),
                datasets: [{
                    label: 'Revenue',
                    data: data.map(item => item.revenue || 0),
                    borderColor: '#ff9800',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: 'white' }
                    },
                    y: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: {
                            color: 'white',
                            callback: value => {
                                if (value >= 1000000) return '₹' + (value/1000000).toFixed(1) + 'M';
                                if (value >= 1000) return '₹' + (value/1000).toFixed(1) + 'k';
                                return '₹' + value;
                            }
                        }
                    }
                }
            }
        });
    }
</script>

<style>
    body {
        background-color: #1a1a1a;
        color: white;
    }
    .dashboard-card {
        background-color: #212121;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .stats-card {
        background-color: #000;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .trend-up {
        color: #4CAF50;
    }
    .trend-down {
        color: #f44336;
    }
    .form-control {
        background-color: #333;
        border-color: #444;
        color: white;
    }
    .form-control:focus {
        background-color: #444;
        border-color: #555;
        color: white;
    }
    .btn {
        padding: 8px 16px;
    }
    h4 {
        margin: 10px 0;
        font-size: 24px;
    }
</style>
{% endblock %}