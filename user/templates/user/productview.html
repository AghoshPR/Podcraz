{% extends "user/base.html" %}
{% load static %}
{% block head %}

<link rel="stylesheet" href="{% static 'css/productview.css' %}">
{% endblock %}

{% block content %}
{% csrf_token %}
<body>
    <style>
    .color-box {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin: 5px;
    border: 5px solid transparent;
    cursor: pointer;
}
.quantity-selector {
    display: flex;
    align-items: center;
    gap: 10px;
}

.quantity-selector input {
    width: 60px;
    text-align: center;
}

.cart-toggle {
    transition: all 0.3s ease;
}

.cart-toggle:disabled {
    background-color: #28a745;
    border-color: #28a745;
}

.toast {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

  </style>
    <div class="container mt-4">
        <div class="row">
            <!-- Product Images -->
             
            <div class="col-md-6">
                <div class="product-gallery d-flex">
                    <div class="thumbnail-images">
                        {% for image in product_images %}
                            <img src="{{ image.image_path.url }}" alt="Image {{ forloop.counter }}" class="thumbnail" onclick="changeMainImage('{{ image.image_path.url }}')">
                        {% endfor %}
                    </div>
                    <div class="main-image-container">
                        {% if product_images %}
                            <img src="{{ product_images.0.image_path.url }}" alt="{{ product.name }}" class="main-image" id="main-image">
                        {% else %}
                            <img src="/static/images/no-image.png" alt="No Image Available" class="main-image" id="main-image">
                        {% endif %}
                    </div>
                </div>
                <div class="product-description mb-4">
                    <h6>Description:</h6>
                    <p>{{ product_variants.product.description }}</p>
                </div>
            </div>

            <!-- Product Details -->
            <div class="col-md-6">
                <div class="product-info">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>
                            {{ product_variants.product.name }}
                            <button 
                                class="btn btn-link p-0 wishlist-toggle ms-2 align-middle" 
                                data-variant-id="{{ product_variants.id }}" 
                                data-is-wishlisted="{% if product_variants.id in user_wishlist %}true{% else %}false{% endif %}">
                                <i class="bi {% if product_variants.id in user_wishlist %}bi-heart-fill text-danger{% else %}bi-heart{% endif %}" 
                                   style="font-size: 1.5rem;"></i>
                            </button>
                        </h2>
                    </div>

                    <div class="rating mb-3">
                        <i class="bi bi-star-fill text-warning"></i>
                        <i class="bi bi-star-fill text-warning"></i>
                        <i class="bi bi-star-fill text-warning"></i>
                        <i class="bi bi-star-fill text-warning"></i>
                        <i class="bi bi-star-half text-warning"></i>
                        <span class="ms-2">4.5</span>
                    </div>

                    
                        <h3 class="mb-4">Price: ₹{{ product_variants.price }}</h3>
                        <div class="mb-4">
                            <h6>Color: {{ product_variants.color }}</h6>
                        </div>
                    

                        <div class="mb-4">
                            <h6>Color:</h6>
                            <div class="color-options d-flex">
                                {% if related_variants %}
                                    {% for related_variant in related_variants %}
                                        <div>
                                            {% if related_variant.id == product_variants.id %}
                                                <div 
                                                    class="color-box selected-color" 
                                                    style="background-color: {{ related_variant.color }};" 
                                                    aria-selected="true" 
                                                    title="Selected color: {{ related_variant.color_name }}">
                                                </div>
                                            {% else %}
                                                <a href="{% url 'userproductview' related_variant.id %}" 
                                                   title="Switch to {{ related_variant.color_name }}">
                                                    <div 
                                                        class="color-box border border-primary" 
                                                        style="background-color: {{ related_variant.color }};">
                                                    </div>
                                                </a>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p>No color options available.</p>
                                {% endif %}
                            </div>
                        </div>
                        

                    

                        <div class="quantity-selector mb-4">
                            <button class="btn btn-outline-secondary decrease-quantity">-</button>
                            <input type="number" value="1" min="1" max="4" class="form-control quantity-input" readonly>
                            <button class="btn btn-outline-secondary increase-quantity">+</button>
                        </div>

                        <div class="d-flex gap-3 mb-4">
                            <button 
                                class="btn btn-primary cart-toggle flex-grow-1" 
                                data-variant-id="{{ product_variants.id }}">
                                Add to Cart
                            </button>
                            <button class="btn btn-buy-now text-white flex-grow-1">Buy Now</button>
                        </div>

                    <div class="delivery-info d-flex gap-3">
                        <!-- Box 1: Free Delivery -->
                        <div class="p-3 border rounded text-center flex-grow-1">
                            <i class="bi bi-truck fs-4"></i>
                            <p class="mb-0 mt-2">Free Delivery</p>
                        </div>
                        <!-- Box 2: Return Policy -->
                        <div class="p-3 border rounded text-center flex-grow-1">
                            <i class="bi bi-arrow-return-left fs-4"></i>
                            <p class="mb-0 mt-2">7 Days Return Policy</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Similar Products -->
        <div class="similar-products">
            <h4 class="mb-4">Similar Products</h4>
            <div class="row row-cols-1 row-cols-md-4 g-4">
                <!-- Similar product cards -->
                <div class="col">
                    <div class="card h-100">
                        <div class="rating-stars p-2">
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star"></i>
                        </div>
                        <img src="{% static 'images/bestseller.png' %}" class="card-img-top" alt="BTG 1 Earbuds">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="product-title mb-0">BTG 1 Earbuds</h5>
                                <span class="discount">24% off</span>
                            </div>
                            <div class="price-container mb-2">
                                <span class="current-price">₹13999</span>
                                <span class="original-price">₹5999</span>
                                <button class="btn btn-outline-danger btn-sm">
                                    <i class="bi bi-heart"></i>
                                </button>
                            </div>
                            <p class="free-delivery mb-2">Free Delivery</p>
                        </div>
                    </div>
                </div>
                <!-- Repeat similar blocks for other similar products -->
            </div>
        </div>
    </div>

    <script>
        function changeMainImage(imageUrl) {
            document.getElementById("main-image").src = imageUrl;
        }
    
        // Quantity Control
        let quantity = 1;
        const quantityInput = document.querySelector('.quantity-input');
        
        document.querySelector('.decrease-quantity').addEventListener('click', () => {
            if (quantity > 1) {
                quantity--;
                quantityInput.value = quantity;
            }
        });
        
        document.querySelector('.increase-quantity').addEventListener('click', () => {
            if (quantity < 4) {
                quantity++;
                quantityInput.value = quantity;
            }
        });
    
        // Wishlist Toggle
        document.querySelector('.wishlist-toggle').addEventListener('click', function(e) {
            e.preventDefault();
            const variantId = this.dataset.variantId;
            const isWishlisted = this.dataset.isWishlisted === 'true';
            const icon = this.querySelector('i');
    
            fetch("{% url 'toggle_wishlist' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({
                    variant_id: variantId,
                    action: isWishlisted ? 'remove' : 'add',
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Toggle icon
                    icon.classList.toggle('bi-heart');
                    icon.classList.toggle('bi-heart-fill');
                    icon.classList.toggle('text-danger');
                    this.dataset.isWishlisted = (!isWishlisted).toString();
                    
                    // Show toast message
                    showToast(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    
        // Add to Cart
        document.querySelector('.cart-toggle').addEventListener('click', function(e) {
            e.preventDefault();
            const variantId = this.dataset.variantId;
            
            fetch("{% url 'add_to_cart' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({
                    product_variant_id: variantId,
                    quantity: quantity
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Show success message
                    showToast(data.message);
                    
                    // Change button text temporarily
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-check2"></i> Added to Cart';
                    this.disabled = true;
                    
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }, 2000);
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error adding to cart', 'error');
            });
        });
    
        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = new bootstrap.Toast(document.getElementById('wishlistToast'));
            const toastMessage = document.getElementById('wishlistToastMessage');
            toastMessage.textContent = message;
            toastMessage.className = type === 'success' ? 'text-success' : 'text-danger';
            toast.show();
        }
    </script>
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="wishlistToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">
                <span id="wishlistToastMessage"></span>
            </div>
        </div>
    </div>
</body>
{% endblock %}
